{"version":3,"file":"session-helper.js","sourceRoot":"","sources":["../../src/session-helper.ts"],"names":[],"mappings":"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","sourcesContent":["import { logging } from './logging';\nimport { StorageProvider } from './StorageProvider';\n\ninterface AuthCryptoData {\n  challenge: string;\n  verifier: string;\n}\n\nexport class SessionHelper {\n  private authDataKey = 'ionicauth.authdata';\n  private expiresAtKey = 'ionicauth.expiresAt';\n  private nonceKey = 'ionicauth.nonce';\n  private tokenScopes = 'ionicauth.scopes';\n  private overrideUrlKey = 'ionicauth.overrideUrl';\n  private expiresAtKeys: string[] = [];\n  private tokenScopesKeys: string[] = [];\n  private storage: StorageProvider;\n\n  constructor(clientId: string, storage: StorageProvider) {\n    this.authDataKey = clientId + '.' + this.authDataKey;\n    this.expiresAtKey = clientId + '.' + this.expiresAtKey;\n    this.nonceKey = clientId + '.' + this.nonceKey;\n    this.overrideUrlKey = clientId + '.' + this.overrideUrlKey;\n    this.tokenScopes = clientId + '.' + this.tokenScopes;\n    this.storage = storage;\n  }\n\n  async getAuthData() {\n    const dataKey = await this.storage.get(this.authDataKey);\n    if (dataKey) {\n      const session: AuthCryptoData = JSON.parse(dataKey);\n      return session;\n    } else {\n      return undefined;\n    }\n  }\n\n  async setAuthData(session: AuthCryptoData) {\n    await this.storage.set(this.authDataKey, JSON.stringify(session));\n  }\n\n  async setOverrideUrl(url: string) {\n    await this.storage.set(this.overrideUrlKey, url);\n  }\n\n  async getOverrideUrl() {\n    const overrideUrl = await this.storage.get(this.overrideUrlKey);\n    return overrideUrl ? overrideUrl : undefined;\n  }\n\n  async clearOverrideUrl() {\n    await this.storage.remove(this.overrideUrlKey);\n  }\n\n  async clearAuthData() {\n    await this.storage.remove(this.authDataKey);\n  }\n\n  async getExpiresAt(tokenName?: string) {\n    let expiresAtKeyName = this.expiresAtKey;\n    if (tokenName) {\n      expiresAtKeyName = this.expiresAtKey + '.' + tokenName;\n    }\n    const expiresAtKey = await this.storage.get(expiresAtKeyName);\n    if (expiresAtKey) {\n      const expiresAt: number | undefined = JSON.parse(expiresAtKey);\n      return expiresAt;\n    }\n    return undefined;\n  }\n\n  async setExpiresAt(expiresAt: number, tokenName?: string) {\n    let expiresAtKey = this.expiresAtKey;\n    if (tokenName) {\n      expiresAtKey = this.expiresAtKey + '.' + tokenName;\n      this.tokenScopesKeys.push(expiresAtKey);\n    }\n    logging.debug('setExpiresAt', 'expiresAtKey', expiresAtKey);\n    await this.storage.set(expiresAtKey, JSON.stringify(expiresAt));\n  }\n\n  async getTokenScopes(tokenName: string) {\n    let tokenScopesKey = this.tokenScopes + '.' + tokenName;\n    logging.debug('getTokenScopes', 'tokenScopes', tokenScopesKey);\n    const tokenScopes = await this.storage.get(tokenScopesKey);\n    if (tokenScopes) {\n      const expiresAt: string | undefined = JSON.parse(tokenScopes);\n      return expiresAt;\n    }\n    return undefined;\n  }\n\n  async setTokenScopes(scopes: string, tokenName: string) {\n    let tokenScopesKey = this.tokenScopes + '.' + tokenName;\n    this.tokenScopesKeys.push(tokenScopesKey);\n    logging.debug('setTokenScopes', 'tokenScopes', tokenScopesKey);\n    await this.storage.set(tokenScopesKey, JSON.stringify(scopes));\n  }\n\n  async clearTokenScopes() {\n    this.tokenScopesKeys.forEach(async key => {\n      await this.storage.remove(key);\n    });\n  }\n\n  async clearExpiresAt() {\n    await this.storage.remove(this.expiresAtKey);\n    this.expiresAtKeys.forEach(async key => {\n      await this.storage.remove(key);\n    });\n  }\n\n  async getNonce() {\n    const nonceKey = await this.storage.get(this.nonceKey);\n    if (nonceKey) {\n      const nonce: string | undefined = JSON.parse(nonceKey);\n      return nonce;\n    }\n    return undefined;\n  }\n\n  async setNonce(nonce: string) {\n    await this.storage.set(this.nonceKey, JSON.stringify(nonce));\n  }\n\n  async clearNonce() {\n    await this.storage.remove(this.nonceKey);\n  }\n\n  async clear() {\n    await this.clearAuthData();\n    await this.clearExpiresAt();\n    await this.clearNonce();\n    await this.clearTokenScopes();\n  }\n}\n"]}