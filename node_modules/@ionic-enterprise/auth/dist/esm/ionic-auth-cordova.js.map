{"version":3,"file":"ionic-auth-cordova.js","sourceRoot":"","sources":["../../src/ionic-auth-cordova.ts"],"names":[],"mappings":"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","sourcesContent":["import { AuthResult, IIonicAuth } from './interfaces';\nimport { UrlInfo } from './UrlInfo';\nimport { IonicSecureWebView } from './SecureWebView';\nimport parse from 'url-parse';\nimport { IonicBaseAuth } from './base-auth';\nimport { UrlHelper } from './urlHelper';\n\nconst ready = new Promise<void>(resolve => {\n  const DEVICE_READY_TIMEOUT = 5000;\n  const readyTimeout = setTimeout(() => {\n    console.warn(`Auth Connect: deviceready did not fire within ${DEVICE_READY_TIMEOUT}ms.`);\n    resolve();\n  }, DEVICE_READY_TIMEOUT);\n\n  document.addEventListener('deviceready', () => {\n    clearTimeout(readyTimeout);\n    resolve();\n  });\n});\n\nexport class IonicNativeAuth<IdToken extends {} = any>\n  extends IonicBaseAuth<IdToken>\n  implements IIonicAuth<IdToken>\n{\n  protected logTag: string = 'IonicNativeAuth: ';\n\n  protected async internalGetToken(\n    codeName: string,\n    code: string,\n    grantType: string,\n    verifier: any,\n    scope: string | undefined,\n  ): Promise<AuthResult> {\n    let payload: any;\n\n    payload = {\n      grant_type: grantType,\n      client_id: this.options.clientID,\n      code_verifier: verifier,\n      redirect_uri: String(this.options.redirectUri),\n    };\n    payload[codeName] = String(code);\n\n    const tokenUrlInfo: UrlInfo = await this.authConfig.getTokenUrl();\n    const tokenUrl: string = tokenUrlInfo.url || '';\n    if (tokenUrlInfo.payload) {\n      payload = { ...tokenUrlInfo.payload, ...payload };\n    }\n\n    if (scope != undefined) {\n      payload.scope = scope;\n    }\n\n    let headers = {};\n    if (tokenUrlInfo.headers) {\n      headers = tokenUrlInfo.headers;\n    } else {\n      headers = {\n        'Content-Type': 'application/json',\n      };\n    }\n    // need to await device ready\n\n    return await UrlHelper.post(tokenUrl, payload, headers)\n      .then(async response => {\n        const result = JSON.parse(response.data);\n        if (this.storage.setAuthResponse && grantType != 'refresh_token') {\n          await this.storage.setAuthResponse(result);\n        }\n        this.logger.debug(this.logTag, 'got result', result);\n        this.logger.debug(this.logTag, 'access_token', result.access_token);\n        this.logger.debug(this.logTag, 'id_token', result.id_token);\n        this.logger.debug(this.logTag, 'refresh_token', result.refresh_token);\n        this.logger.debug(this.logTag, 'profile_info', result.profile_info);\n        this.logger.debug(this.logTag, 'expires_in', result.expires_in);\n        const authResult: AuthResult = {\n          accessToken: result.access_token,\n          idToken: result.id_token,\n          refreshToken: result.refresh_token,\n          expiresIn: result.expires_in,\n          scope: result.scope,\n          tokenType: result.token_type,\n        };\n        return authResult;\n      })\n      .catch(error => {\n        this.logger.debug(tokenUrl, this.logTag, ' - tokenUrl');\n        this.logger.debug(headers, this.logTag, ' - headers');\n        this.logger.debug(payload, this.logTag, ' - payload');\n        this.logger.error(this.logTag, error);\n        return {};\n      });\n  }\n\n  async internalHandleCallback(url: string, _externalCallback: boolean): Promise<AuthResult> {\n    const session = await this.session.getAuthData();\n    if (!session) {\n      throw new Error('No session data stored');\n    }\n    let { code } = parse(url, true).query;\n    await ready;\n    let grantType = 'authorization_code';\n    let codeName = 'code';\n\n    try {\n      const result = await this.internalGetToken(\n        codeName,\n        code as string,\n        grantType,\n        session.verifier,\n        undefined,\n      );\n\n      await this.setSession(result);\n      await this.session.clearAuthData();\n\n      IonicSecureWebView.hide(\n        data => {\n          this.logger.debug(this.logTag, 'IonicSecureWebView.hide succeeded: ', data);\n        },\n        err => {\n          this.logger.error(this.logTag, 'IonicSecureWebView.hide failed: ', err);\n        },\n      );\n      return result;\n    } catch (err) {\n      await this.session.clearAuthData();\n      this.logout();\n      throw err;\n    }\n  }\n\n  async refreshSession(tokenName?: string): Promise<void> {\n    await this.getOverrideDiscoveryUrl();\n    this.logger.debug(this.logTag, 'refresh flow');\n    const url = await this.authConfig.getTokenUrl();\n    const nonce = await this.session.getNonce();\n    const refreshToken = await this.getRefreshToken();\n    if (!refreshToken) {\n      throw new Error('No refresh token available');\n    }\n    let payload: any;\n    payload = {\n      client_id: this.options.clientID,\n      refresh_token: refreshToken,\n      grant_type: 'refresh_token',\n      nonce,\n      state: nonce,\n    };\n\n    if (url.payload) {\n      payload = { ...url.payload, ...payload };\n    }\n    let secondaryToken = false;\n    if (tokenName) {\n      payload.scope = await this.session.getTokenScopes(tokenName);\n      secondaryToken = true;\n    }\n\n    const headers = url.headers ? url.headers : { 'Content-Type': 'application/json' };\n\n    await ready;\n    return await UrlHelper.post(url.url || '', payload, headers)\n      .then(async response => {\n        const result = JSON.parse(response.data);\n        if (this.storage.setAuthResponse && !secondaryToken) {\n          await this.storage.setAuthResponse(result);\n        }\n\n        const authResult = {\n          accessToken: result.access_token,\n          idToken: result.id_token,\n          refreshToken: result.refresh_token,\n          expiresIn: result.expires_in,\n          scope: result.scope,\n          tokenType: result.token_type,\n        };\n        await this.setSession(authResult, tokenName, result.scope);\n        return;\n      })\n      .catch(error => {\n        this.logger.debug(this.logTag, 'tokenUrl: ' + url.url);\n        this.logger.debug(this.logTag, 'headers: ', headers);\n        this.logger.debug(this.logTag, 'payload: ', payload);\n        this.logger.error(this.logTag, error);\n        throw error;\n      });\n  }\n\n  protected showUrl(url: string, options?: { hide?: boolean }): Promise<any> {\n    return new Promise((resolve, reject) => {\n      let curOptions: { [key: string]: any } = {};\n      if (this.options.androidToolbarColor) {\n        curOptions = {\n          ...curOptions,\n          toolbarColor: this.options.androidToolbarColor,\n        };\n      }\n      if (this.options.safariWebViewOptions) {\n        curOptions = { ...curOptions, ...this.options.safariWebViewOptions };\n      }\n\n      this.logger.debug(this.logTag, 'webView option: ', this.authConfig.options.iosWebView);\n      const params = Object.assign(\n        {},\n        {\n          url,\n          callbackUrl: this.authConfig.options.redirectUri,\n          iosWebView: this.authConfig.options.iosWebView,\n        },\n        curOptions,\n      );\n      this.logger.debug(this.logTag, 'using params: ', params);\n      IonicSecureWebView.show(\n        params,\n        (result: any) => {\n          this.logger.debug(this.logTag, 'result :', result);\n          resolve(result);\n        },\n        (error: any) => {\n          this.logger.error(this.logTag, 'show failed: ', error);\n          reject(error);\n        },\n      );\n    });\n  }\n}\n"]}